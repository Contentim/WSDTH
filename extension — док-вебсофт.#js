const vscode = require('vscode');
const axios = require('axios');

// ÐšÐ»Ð°ÑÑ Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð° Ð´ÐµÑ€ÐµÐ²Ð°
class TreeItem extends vscode.TreeItem {
    constructor(label, collapsibleState, type = 'file', children = [], id = null) {
        super(label, collapsibleState);
        this.children = children;
        this.type = type;
        this.contextValue = type;
        this.id = id;
        
        // Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¸ÐºÐ¾Ð½ÐºÐ¸ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ñ‚Ð¸Ð¿Ð°
        switch (type) {
            case 'folder':
                this.iconPath = new vscode.ThemeIcon('folder');
                break;
            case 'array':
                this.iconPath = new vscode.ThemeIcon('symbol-array');
                break;
            case 'string':
                this.iconPath = new vscode.ThemeIcon('symbol-string');
                break;
            case 'api':
                this.iconPath = new vscode.ThemeIcon('cloud');
                break;
            case 'typescript':
                this.iconPath = new vscode.ThemeIcon('file-code');
                break;
            case 'json':
                this.iconPath = new vscode.ThemeIcon('json');
                break;
            case 'css':
                this.iconPath = new vscode.ThemeIcon('file-media');
                break;
            case 'html':
                this.iconPath = new vscode.ThemeIcon('file-text');
                break;
            default:
                this.iconPath = new vscode.ThemeIcon('file');
        }

        // Ð”Ð»Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ñ
        if (type !== 'folder' && children.length === 0) {
            this.command = {
                command: 'treeview-activitybar-demo.openFile',
                title: 'Open File',
                arguments: [this]
            };
        }
    }
}

// ÐŸÑ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð³Ð¾ TreeView
class TreeDataProvider {
    constructor() {
        this._onDidChangeTreeData = new vscode.EventEmitter();
        this.onDidChangeTreeData = this._onDidChangeTreeData.event;
        this.data = this.getDemoData();
        this.apiData = [];
    }

    // Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð´ÐµÐ¼Ð¾-Ð´Ð°Ð½Ð½Ñ‹Ñ…
    getDemoData() {
        return [
            new TreeItem('Local Project', vscode.TreeItemCollapsibleState.Expanded, 'folder', [
                new TreeItem('src', vscode.TreeItemCollapsibleState.Collapsed, 'folder', [
                    new TreeItem('App.tsx', vscode.TreeItemCollapsibleState.None, 'typescript'),
                    new TreeItem('index.tsx', vscode.TreeItemCollapsibleState.None, 'typescript')
                ]),
                new TreeItem('package.json', vscode.TreeItemCollapsibleState.None, 'json')
            ]),
            new TreeItem('API Data', vscode.TreeItemCollapsibleState.Collapsed, 'api', [])
        ];
    }

    // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð· API
    async loadFromAPI() {
        // const apiBaseUrl = 'http://localhost:5000/notes';
        const apiBaseUrl = 'https://jsonplaceholder.typicode.com/todos/';
        const noteIds = [4, 6, 7, 8];
        
        vscode.window.withProgress({
            location: vscode.ProgressLocation.Notification,
            title: 'Loading data from API...',
            cancellable: false
        }, async (progress) => {
            progress.report({ increment: 0 });

            try {
                const requests = noteIds.map(id => 
                    axios.get(`${apiBaseUrl}/${id}`)
                        .then(response => ({
                            id,
                            name: response.data.name,
                            success: true
                        }))
                        .catch(error => ({
                            id,
                            name: `Error loading ID ${id}`,
                            success: false,
                            error: error.message
                        }))
                );

				

                const results = await Promise.all(requests);
                
                // Ð Ð°Ð·Ð´ÐµÐ»ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑÐ¼
                const arrayItems = results.filter(item => [4, 6].includes(item.id));
                const stringItems = results.filter(item => [7, 8].includes(item.id));

                // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹ Ð´ÐµÑ€ÐµÐ²Ð° Ð´Ð»Ñ API Ð´Ð°Ð½Ð½Ñ‹Ñ…
                const apiChildren = [
                    new TreeItem('Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ Ð¼Ð°ÑÑÐ¸Ð²Ð°Ð¼Ð¸', vscode.TreeItemCollapsibleState.Expanded, 'folder', 
                        arrayItems.map(item => 
                            new TreeItem(
                                item.success ? item.title : `ID ${item.id}: ${item.title}`,
                                vscode.TreeItemCollapsibleState.None,
                                'array',
                                [],
                                item.id
                            )
                        )
                    ),
                    new TreeItem('Ð Ð°Ð±Ð¾Ñ‚Ð° ÑÐ¾ ÑÑ‚Ñ€Ð¾ÐºÐ°Ð¼Ð¸', vscode.TreeItemCollapsibleState.Expanded, 'folder', 
                        stringItems.map(item => 
                            new TreeItem(
                                item.success ? item.title : `ID ${item.id}: ${item.title}`,
                                vscode.TreeItemCollapsibleState.None,
                                'string',
                                [],
                                item.id
                            )
                        )
                    )
                ];

				console.log(apiChildren)

                // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ API
                this.apiData = results;

                // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð´ÐµÑ€ÐµÐ²Ð¾
                this.data[1].children = apiChildren;
                this.data[1].children = new TreeItem('package.json', vscode.TreeItemCollapsibleState.None, 'json');
                this._onDidChangeTreeData.fire();

                // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ
                const successCount = results.filter(r => r.success).length;
                const errorCount = results.filter(r => !r.success).length;
                
                vscode.window.showInformationMessage(
                    `API data loaded! Success: ${successCount}, Errors: ${errorCount}`
                );

                progress.report({ increment: 100 });

            } catch (error) {
                vscode.window.showErrorMessage(`Failed to load API data: ${error.message}`);
                progress.report({ increment: 100 });
            }
        });
    }

    getTreeItem(element) {
        return element;
    }

    getChildren(element) {
        if (!element) {
            return this.data;
        }
        return element.children;
    }

    refresh() {
        this._onDidChangeTreeData.fire();
        vscode.window.showInformationMessage('ðŸŒ³ Tree refreshed!');
    }

    addItem(parent) {
        const newItem = new TreeItem(
            `New_Item_${Math.random().toString(36).substr(2, 5)}`, 
            vscode.TreeItemCollapsibleState.None,
            'file'
        );
        
        if (parent && parent.type === 'folder') {
            parent.children.push(newItem);
        } else {
            this.data.push(newItem);
        }
        
        this._onDidChangeTreeData.fire();
    }

    editItem(item) {
        vscode.window.showInputBox({
            prompt: 'Enter new name:',
            value: item.label
        }).then(newName => {
            if (newName) {
                item.label = newName;
                this._onDidChangeTreeData.fire();
            }
        });
    }

    deleteItem(item) {
        const deleteFromArray = (array, target) => {
            const index = array.indexOf(target);
            if (index > -1) {
                array.splice(index, 1);
                return true;
            }
            
            for (const element of array) {
                if (element.children && deleteFromArray(element.children, target)) {
                    return true;
                }
            }
            
            return false;
        };

        if (deleteFromArray(this.data, item)) {
            this._onDidChangeTreeData.fire();
            vscode.window.showInformationMessage(`Deleted: ${item.label}`);
        }
    }

    // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð´Ð»Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ð¹ Ð¿Ð°Ð½ÐµÐ»Ð¸
    getStats() {
        const totalApiItems = this.apiData.length;
        const successApiItems = this.apiData.filter(item => item.success).length;
        const errorApiItems = this.apiData.filter(item => !item.success).length;

        return {
            totalApiItems,
            successApiItems,
            errorApiItems
        };
    }
}

// ÐŸÑ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€ Ð´Ð»Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ð¹ Ð¿Ð°Ð½ÐµÐ»Ð¸
class InfoDataProvider {
    constructor(treeDataProvider) {
        this.treeDataProvider = treeDataProvider;
    }

    getTreeItem(element) {
        return element;
    }

    getChildren() {
        const stats = this.treeDataProvider.getStats();
        
        return [
            new vscode.TreeItem('ðŸ“Š API Statistics', vscode.TreeItemCollapsibleState.None),
            new vscode.TreeItem(`âœ… Successful requests: ${stats.successApiItems}`, vscode.TreeItemCollapsibleState.None),
            new vscode.TreeItem(`âŒ Failed requests: ${stats.errorApiItems}`, vscode.TreeItemCollapsibleState.None),
            new vscode.TreeItem(`ðŸ“‹ Total API items: ${stats.totalApiItems}`, vscode.TreeItemCollapsibleState.None),
            new vscode.TreeItem('', vscode.TreeItemCollapsibleState.None), // Ð Ð°Ð·Ð´ÐµÐ»Ð¸Ñ‚ÐµÐ»ÑŒ
            new vscode.TreeItem('ðŸŽ¯ Available IDs: 4, 6, 7, 8', vscode.TreeItemCollapsibleState.None),
            new vscode.TreeItem('ðŸ“ Arrays: IDs 4, 6', vscode.TreeItemCollapsibleState.None),
            new vscode.TreeItem('ðŸ“ Strings: IDs 7, 8', vscode.TreeItemCollapsibleState.None),
            new vscode.TreeItem('', vscode.TreeItemCollapsibleState.None),
            new vscode.TreeItem('ðŸŒ API: http://localhost:5000/notes/:id', vscode.TreeItemCollapsibleState.None)
        ];
    }
}

function activate(context) {
    console.log('TreeView Activity Bar extension activated');

    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
    const treeDataProvider = new TreeDataProvider();
    const infoDataProvider = new InfoDataProvider(treeDataProvider);

    // Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÐ¼ TreeView Ð² activity bar
    const treeView = vscode.window.createTreeView('treeview-activitybar-demo.treeView', {
        treeDataProvider: treeDataProvider,
        showCollapseAll: true
    });

    const infoView = vscode.window.createTreeView('treeview-activitybar-demo.infoView', {
        treeDataProvider: infoDataProvider
    });

    // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹
    treeView.onDidChangeSelection(event => {
        if (event.selection.length > 0) {
            const selectedItem = event.selection[0];
            if (selectedItem.id) {
                vscode.window.showInformationMessage(`Selected: ${selectedItem.label} (ID: ${selectedItem.id})`);
            } else {
                vscode.window.showInformationMessage(`Selected: ${selectedItem.label}`);
            }
        }
    });

    // Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
    const commands = [
        vscode.commands.registerCommand('treeview-activitybar-demo.refresh', () => {
            treeDataProvider.refresh();
            infoDataProvider._onDidChangeTreeData?.fire(); // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾ Ð¿Ð°Ð½ÐµÐ»ÑŒ
        }),

        vscode.commands.registerCommand('treeview-activitybar-demo.addItem', (node) => {
            treeDataProvider.addItem(node);
        }),

        vscode.commands.registerCommand('treeview-activitybar-demo.editItem', (node) => {
            treeDataProvider.editItem(node);
        }),

        vscode.commands.registerCommand('treeview-activitybar-demo.deleteItem', (node) => {
            treeDataProvider.deleteItem(node);
        }),

        vscode.commands.registerCommand('treeview-activitybar-demo.openFile', (node) => {
            if (node.id) {
                vscode.window.showInformationMessage(`Opening API item: ${node.label} (ID: ${node.id})`);
            } else {
                vscode.window.showInformationMessage(`Opening: ${node.label}`);
            }
        }),

        vscode.commands.registerCommand('treeview-activitybar-demo.showInfo', () => {
            vscode.window.showInformationMessage('ðŸŒ³ TreeView Demo Extension\nðŸ“Œ Located in Activity Bar\nðŸŒ Supports REST API');
        }),

        vscode.commands.registerCommand('treeview-activitybar-demo.loadFromAPI', () => {
            treeDataProvider.loadFromAPI().then(() => {
                // ÐŸÐ¾ÑÐ»Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½ÑƒÑŽ Ð¿Ð°Ð½ÐµÐ»ÑŒ
                if (infoDataProvider._onDidChangeTreeData) {
                    infoDataProvider._onDidChangeTreeData.fire();
                }
            });
        })
    ];

    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð²ÑÐµ Ð² ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚
    commands.forEach(command => context.subscriptions.push(command));
    context.subscriptions.push(treeView);
    context.subscriptions.push(infoView);

    // ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸ Ð°ÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸
    setTimeout(() => {
        vscode.window.showInformationMessage('Click "Load from API" to fetch data from http://localhost:5000');
    }, 2000);
}

function deactivate() {}

module.exports = {
    activate,
    deactivate
};